pipeline {
    agent any
    environment {
        CHAPTER = 'Chapter-13'
    }

    stages {
        stage('Build') {
            steps {
                echo "Building"
                checkout scm
            }
        }
        stage('Style') {
            agent {
                docker 'python:3'
            }

            steps {
                sh '''
                    #!/bin/bash

                    cd "${CHAPTER}"
                    python -m pip install -r requirements.txt
                    cd Flask-YouTube
                    python setup.py build
                    python setup.py install
                    cd ..
                    python -m pip install flake8
                    flake8 --max-line-length 120 webapp
                '''
            }
        }
        stage('Test') {
            agent {
                docker 'python:3'
            }
            steps {
                sh '''
                    #!/bin/bash

                    cd "${CHAPTER}"
                    python -m pip install -r requirements.txt
                    cd Flask-YouTube
                    python setup.py build
                    python setup.py install
                    cd ..
                    python -m pip install coverage
                    coverage run --source webapp --branch -m unittest tests.test_urls.TestURLs
                    coverage report
                '''
            }
       }
       stage('Build docker images') {
           agent any
           steps {
               echo 'Creating new image...'
               script {
                    def customImage = docker.build("myblog:${env.BUILD_ID}", "-f deploy/docker/Dockerfile_frontend .")
               }
           }
       }
       stage('Publish Docker Image') {
           agent any
           when { tag "release-*" }
           steps {
               echo 'Creating new image...'
           }
       }
    }
}
